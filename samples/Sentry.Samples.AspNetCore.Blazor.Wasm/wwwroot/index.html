<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BlazorApp1</title>
    <base href="/" />
    <style>
        body {
            background-color: black;
            color: white;
        }
    </style>
</head>

<body>

<div id="app">Loading...</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>
<script src="_content/Sentry.AspNetCore.Blazor/bundle.tracing.replay.debug.min.js"></script>
<script type="text/javascript">
Sentry.init({
    dsn: 'https://eb18e953812b41c3aeb042e666fd3b5c@o447951.ingest.sentry.io/5428537',
    // debug: true,
    integrations: [
        new Sentry.BrowserTracing(),
        new Sentry.Replay(),
    ],
    replaysSessionSampleRate: 1.0,
    replaysOnErrorSampleRate: 1.0,
    tracesSampleRate: 1.0,
});


// https://github.com/getsentry/sentry-javascript/blob/develop/packages/wasm/src/registry.ts
function patchWebAssembly() {
    if ('instantiateStreaming' in WebAssembly) {
        const origInstantiateStreaming = WebAssembly.instantiateStreaming;
        console.log("patching WebAssembly.instantiateStreaming")
        WebAssembly.instantiateStreaming = function instantiateStreaming(
            response,
            importObject,
        ) {
            return Promise.resolve(response).then(response => {
                return origInstantiateStreaming(response, importObject).then(rv => {
                    if (response.url) {
                        console.log("Registering WebAssembly module: " + response.url)
                        registerModule(rv.module, response.url);
                    } else {
                        try {
                            // Will fail and give us a stack trace we can use to get the module URL (e.g: wasm://wasm/009931b2)
                            rv.instance.exports.mono_wasm_assembly_find_method(1);
                        } catch (e) {
                            const match = e.stack.match(/^.*(wasm:.*?):wasm-function.*$/m);
                            let url = match[1];
                            if (match !== null) {
                                console.log("WebAssembly module: URL: " + url)
                                registerModule(rv.module, url);
                            }
                        }
                    }
                    return rv;
                });
            });
        };
    }
}

function getModuleInfo(module) {
    const buildIds = WebAssembly.Module.customSections(module, 'build_id');
    let buildId = null;
    let debugFile = null;

    if (buildIds.length > 0) {
        const firstBuildId = new Uint8Array(buildIds[0]);
        buildId = Array.from(firstBuildId).reduce((acc, x) => {
            return acc + x.toString(16).padStart(2, '0');
        }, '');
        console.log("buildId is: " + buildId);

    } else {
        console.log("buildIds: is empty");
    }

    const externalDebugInfo = WebAssembly.Module.customSections(module, 'external_debug_info');
    if (externalDebugInfo.length > 0) {
        const firstExternalDebugInfo = new Uint8Array(externalDebugInfo[0]);
        const decoder = new TextDecoder('utf-8');
        debugFile = decoder.decode(firstExternalDebugInfo);
        console.log("debugFile is: " + debugFile);
    } else {
        console.log("No external_debug_info for module: " + module);
    }

    return { buildId, debugFile };
}

IMAGES = [];
function registerModule(module, url) {
    const { buildId, debugFile } = getModuleInfo(module);
    if (buildId) {
        const oldIdx = getImage(url);
        if (oldIdx >= 0) {
            IMAGES.splice(oldIdx, 1);
        }

        let debugFileUrl = null;
        if (debugFile) {
            try {
                debugFileUrl = new URL(debugFile, url).href;
            } catch (e) {
                console.log("failed to get URL: " + e)
                // debugFile could be a blob URL which causes the URL constructor to throw
                // for now we just ignore this case
            }
        }

        IMAGES.push({
            type: 'wasm',
            codeId: buildId,
            codeFile: url,
            debugFile: debugFileUrl,
            debugId: `${buildId.padEnd(32, '0').slice(0, 32)}0`,
        });
    }
}
function getImages() {
    return IMAGES;
}
function getImage(url) {
    return IMAGES.findIndex(image => {
        return image.type === 'wasm' && image.code_file === url;
    });
}

patchWebAssembly();

</script>
<!--Add Sentry Browser before adding Blazor-->
<script src="_framework/blazor.webassembly.js"></script>
</body>

</html>

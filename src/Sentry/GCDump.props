<Project>
  <PropertyGroup>
    <GCDumpVersion>8.0.547301</GCDumpVersion>
    <GCDumpRootDirectory>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)..\..\tools\gcdump\'))</GCDumpRootDirectory>
    <GCDumpTempDirectory>$(GCDumpRootDirectory)$(GCDumpVersion)\</GCDumpTempDirectory>
    <GCDumpNuGetPackage>$(GCDumpTempDirectory)dotnet-gcdump.$(GCDumpVersion).nupkg</GCDumpNuGetPackage>
    <GCDumpNuGetUrl>https://www.nuget.org/api/v2/package/dotnet-gcdump/$(GCDumpVersion)</GCDumpNuGetUrl>
    <GCDumpIncludeFiles>$(GCDumpTempDirectory)tools\net6.0\any\</GCDumpIncludeFiles>
  </PropertyGroup>

  <Target Name="DownloadGCDump" BeforeTargets="CollectPackageReferences">
    <Message Importance="normal" Text="Found dotnet-gcdump - skipping download... " Condition="Exists('$(GCDumpNuGetPackage)')" />
    <Message Importance="normal" Text="dotnet-gcdump not found... downloading to $(GCDumpTempDirectory)" Condition="!Exists('$(GCDumpNuGetPackage)')" />

    <!-- Download the NuGet package directly -->
    <DownloadFile SourceUrl="$(GCDumpNuGetUrl)" DestinationFolder="$(GCDumpTempDirectory)" Condition="!Exists('$(GCDumpNuGetPackage)')">
      <Output TaskParameter="DownloadedFile" ItemName="GCDumpNuGetPackage" />
    </DownloadFile>

    <!-- Extract the NuGet package -->
    <Unzip SourceFiles="$(GCDumpNuGetPackage)" DestinationFolder="$(GCDumpTempDirectory)" Condition="!Exists('$(GCDumpIncludeFiles)')" />

    <Message Importance="high" Text="Unable to locate dotnet-gcdump nuget after install : $(GCDumpNuGetPackage)" Condition="!Exists('$(GCDumpNuGetPackage)')" />
    <Message Importance="high" Text="Unable to locate dotnet-gcdump files after install : $(GCDumpIncludeFiles)" Condition="!Exists('$(GCDumpIncludeFiles)')" />
  </Target>

  <!-- Include GCDump in the Sentry Nuget package. -->
  <ItemGroup>
    <None Include="$(GCDumpIncludeFiles)**" Pack="true" PackagePath="tools\dotnet-gcdump\" />
  </ItemGroup>

</Project>
